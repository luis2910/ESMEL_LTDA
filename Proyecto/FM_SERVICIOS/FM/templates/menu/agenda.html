{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agenda de Visitas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'menu/css/style.css' %}?v=20241205">
  <style>
    :root {
      --admin-blue: rgb(0, 19, 93);
      --card: #ffffff;
      --border: #e6e9f2;
      --muted: #6b7280;
      --soft: #f6f8ff;
    }
    body { background: #ffffff; }
    .page-shell { max-width: 1200px; }
    .hero {
      background: var(--admin-blue);
      color: #fff;
      border: 1px solid rgba(0,0,0,0.05);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.1);
    }
    .hero h1 { color: #fff; font-weight: 800; }
    .hero p { margin: 0; color: rgba(255,255,255,0.85); }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 999px;
      background: rgba(0,19,93,0.08); color: var(--admin-blue);
      border: 1px solid rgba(0,19,93,0.14); font-weight: 700;
    }
    .card-lite {
      background: var(--card);
      color: inherit;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.05);
    }
    .card-lite .text-muted { color: var(--muted) !important; }
    .card-lite h2, .card-lite h5, .card-lite h6 { color: inherit; }
    .card-lite .table thead { background: #f3f6ff; color: inherit; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 14px; }
    .visit-card {
      background: linear-gradient(135deg, #ffffff 0%, #f5f7ff 80%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      height: 100%;
      box-shadow: 0 12px 30px rgba(0,0,0,0.05);
    }
    .visit-header { display: flex; justify-content: space-between; gap: 10px; align-items: flex-start; margin-bottom: 8px; }
    .visit-title { margin: 0; font-weight: 800; color: #111827; }
    .visit-meta { margin: 0; color: var(--muted); font-size: 0.9rem; }
    .visit-section { font-size: 0.9rem; color: var(--muted); }
    .badge { font-weight: 700; }
    .date-chip {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 12px; border-radius: 14px;
      background: #e8edff; color: #0f172a;
      border: 1px solid #cfd7f0;
      font-weight: 800; font-size: 0.9rem;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
    }
    .divider { border-bottom: 1px dashed var(--border); margin: 8px 0; }
    .actions { border-top: 1px dashed var(--border); padding-top: 10px; }
    .badge-estado { font-weight: 800; }
    .estado-ACEPTADA { background: #e6f6ed; color: #166534; }
    .estado-PENDIENTE { background: #fff4d6; color: #8a6a00; }
    .estado-PROCESO_PAGO { background: #dff7ff; color: #0f5c75; }
    .estado-COMPLETADA { background: #e8edff; color: #14205c; }
    .estado-RECHAZADA { background: #fde2e1; color: #b42318; }
    .estado-DEFAULT { background: #e5e7eb; color: #111827; }
    .btn-primary {
      --bs-btn-bg: var(--admin-blue);
      --bs-btn-border-color: var(--admin-blue);
      --bs-btn-hover-bg: #00104a;
      --bs-btn-hover-border-color: #00104a;
    }
    .btn-outline-danger { --bs-btn-border-color: #f05252; --bs-btn-color: #b91c1c; --bs-btn-hover-bg: #f05252; --bs-btn-hover-border-color: #f05252; --bs-btn-hover-color: #fff; }
    .btn-outline-primary { --bs-btn-border-color: var(--admin-blue); --bs-btn-color: var(--admin-blue); --bs-btn-hover-bg: var(--admin-blue); --bs-btn-hover-border-color: var(--admin-blue); --bs-btn-hover-color: #fff; }
    .btn-outline-secondary { --bs-btn-border-color: rgba(255,255,255,0.6); --bs-btn-color: #fff; --bs-btn-hover-bg: rgba(255,255,255,0.18); --bs-btn-hover-border-color: rgba(255,255,255,0.8); --bs-btn-hover-color: #fff; }
    .filter-pills { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-pills button {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 700;
      color: var(--muted);
      transition: all 0.2s ease;
    }
    .filter-pills button.active {
      background: var(--admin-blue);
      color: #fff;
      border-color: var(--admin-blue);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
    }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

{% include 'menu/partials/navbar.html' %}

<main class="container my-5 flex-grow-1 page-shell">
  <div class="mb-3">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-link p-0 text-decoration-none">&larr; Volver al panel</a>
  </div>

  <section class="hero mb-4">
    <div class="d-flex align-items-center gap-2 mb-1">
      <span class="pill">Agenda interna</span>
      <span class="text-muted small">Visitas programadas</span>
    </div>
    <h1 class="h4 mb-1">Visitas técnicas programadas</h1>
    <p>Registra y controla las salidas del equipo técnico, con detalle de cliente, ubicación y estado.</p>
  </section>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      </div>
    {% endfor %}
  {% endif %}

  <section class="card-lite mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5 mb-0">Nueva visita</h2>
      <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#nuevaVisitaForm" aria-expanded="false" aria-controls="nuevaVisitaForm">
        Nueva visita
      </button>
    </div>
    <div class="collapse" id="nuevaVisitaForm">
      <form method="post" class="row g-3">
        {% csrf_token %}
        <div class="col-md-6">
          <label class="form-label">Cliente / Comunidad *</label>
          <input type="text" name="cliente" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Correo de contacto</label>
          <input type="email" name="correo" class="form-control" placeholder="cliente@correo.com">
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha *</label>
          <input type="date" name="fecha" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Hora *</label>
          <input type="time" name="hora" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Técnico asignado *</label>
          <select name="tecnico" class="form-select" required>
            <option value="">Selecciona un técnico</option>
            {% for tec in tecnicos %}
              <option value="{{ tec.slug }}">{{ tec.nombre }} — {{ tec.especialidad }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Servicio</label>
          <select name="servicio" class="form-select">
            <option value="">Selecciona servicio</option>
            {% for s in servicios_lista %}
              <option value="{{ s.titulo }}">{{ s.titulo }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Región</label>
          <select name="region" class="form-select" id="agendaRegion">
            <option value="">Selecciona región</option>
            {% for nombre in regiones %}
              <option value="{{ nombre }}" {% if nombre == selected_region %}selected{% endif %}>{{ nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Comuna</label>
          <select name="comuna" class="form-select" id="agendaComuna" data-initial="{{ selected_comuna }}">
            <option value="">Selecciona comuna</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Dirección / Ubicación</label>
          <input type="text" name="direccion" class="form-control" placeholder="Ej: Edificio Central, piso 1">
        </div>
        <div class="col-12">
          <label class="form-label">Notas</label>
          <textarea name="notas" rows="3" class="form-control" placeholder="Detalle de la visita, materiales necesarios, etc."></textarea>
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary">Guardar visita</button>
        </div>
      </form>
    </div>
  </section>

  <section class="card-lite">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="h5 mb-0">Visitas agendadas</h2>
        <p class="mb-0 text-muted small">Revisa estados, ubicaciones y notas asociadas.</p>
      </div>
      <span class="badge bg-secondary" id="agendaCounter">{{ visitas|length }}</span>
    </div>
    <div class="d-flex flex-wrap align-items-center gap-2 justify-content-between mb-3">
      <div class="filter-pills" id="agendaFilterPills">
        <button type="button" class="active" data-state="all">Todas</button>
        <button type="button" data-state="ACEPTADA">Aceptadas</button>
        <button type="button" data-state="PROCESO_PAGO">Proceso de pago</button>
        <button type="button" data-state="RECHAZADA">Rechazadas</button>
      </div>
      <div class="d-flex align-items-center gap-2 ms-auto">
        <label for="agendaEmailSearch" class="mb-0 text-muted small">Buscar por correo</label>
        <input type="search" id="agendaEmailSearch" class="form-control form-control-sm" placeholder="cliente@correo.com" style="min-width: 220px;">
      </div>
    </div>
    {% if visitas %}
      <div class="card-grid">
        {% for visita in visitas %}
          <article class="visit-card" data-state="{{ visita.cotizacion.estado|default:'SIN_ESTADO' }}" data-email="{{ visita.correo|default:'' }}">
            <div class="visit-header">
              <div>
                <p class="visit-title mb-1">{{ visita.cliente }}</p>
                <p class="visit-meta mb-0">{{ visita.correo|default:"-" }}</p>
              </div>
              <div class="text-end">
                <span class="date-chip">{{ visita.fecha|date:"d/m/Y" }}{% if visita.hora %} · {{ visita.hora }}{% endif %}</span><br>
                {% if visita.cotizacion %}
                  {% if visita.cotizacion.estado == visita.cotizacion.Estado.ACEPTADA %}
                    <span class="badge estado-ACEPTADA badge-estado">Aceptada</span>
                  {% elif visita.cotizacion.estado == visita.cotizacion.Estado.PENDIENTE %}
                    <span class="badge estado-PENDIENTE badge-estado">Pendiente</span>
                  {% elif visita.cotizacion.estado == visita.cotizacion.Estado.PROCESO_PAGO %}
                    <span class="badge estado-PROCESO_PAGO badge-estado">Proceso de pago</span>
                  {% elif visita.cotizacion.estado == visita.cotizacion.Estado.COMPLETADA %}
                    <span class="badge estado-COMPLETADA badge-estado">Completada</span>
                  {% else %}
                    <span class="badge estado-RECHAZADA badge-estado">{{ visita.cotizacion.get_estado_display }}</span>
                  {% endif %}
                {% else %}
                  <span class="badge estado-DEFAULT badge-estado">Sin cotización</span>
                {% endif %}
              </div>
            </div>

            <div class="visit-section mb-1">
              <strong>Técnico:</strong> {{ visita.tecnico_nombre }}{% if visita.servicio %} · <span class="text-muted">{{ visita.servicio }}</span>{% endif %}
            </div>
            <div class="visit-section mb-1">
              <strong>Región/Comuna:</strong> {{ visita.region|default:"-" }}/{{ visita.comuna|default:"-" }}
            </div>
            <div class="visit-section mb-1">
              <strong>Dirección:</strong> {{ visita.direccion|default:"-" }}
            </div>
            <div class="divider"></div>
            <div class="visit-section mb-2">
              <strong>Notas:</strong> <span style="white-space: pre-line;">{{ visita.notas|default:"-" }}</span>
            </div>

            <div class="d-flex gap-2 flex-wrap actions">
              {% if visita.cotizacion %}
                {% if visita.cotizacion.estado == visita.cotizacion.Estado.PROCESO_PAGO or visita.cotizacion.estado == visita.cotizacion.Estado.COMPLETADA or visita.cotizacion.estado == visita.cotizacion.Estado.RECHAZADA %}
                  <span class="text-muted small">No editable</span>
                {% elif visita.cotizacion.estado != visita.cotizacion.Estado.ACEPTADA %}
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'agenda_visita_editar' visita.pk %}">Editar</a>
                  <form method="post" action="{% url 'agenda_visita_eliminar' visita.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar esta visita?')">Eliminar</button>
                  </form>
                {% else %}
                  <span class="text-muted small">No editable</span>
                {% endif %}
              {% else %}
                <a class="btn btn-sm btn-outline-primary" href="{% url 'agenda_visita_editar' visita.pk %}">Editar</a>
                <form method="post" action="{% url 'agenda_visita_eliminar' visita.pk %}" class="d-inline">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar esta visita?')">Eliminar</button>
                </form>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mb-0">Aún no se han agendado visitas.</p>
    {% endif %}
  </section>
</main>

{% include 'menu/partials/footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function () {
    const regionesData = JSON.parse('{{ regiones_json|escapejs }}');
    const regionSelect = document.getElementById("agendaRegion");
    const comunaSelect = document.getElementById("agendaComuna");
    if (!regionSelect || !comunaSelect) return;

    function renderComunas(selected) {
      const region = regionSelect.value;
      const comunas = regionesData[region] || [];
      comunaSelect.innerHTML = '<option value="">Selecciona comuna</option>';
      comunas.forEach(function (nombre) {
        const opt = document.createElement("option");
        opt.value = nombre;
        opt.textContent = nombre;
        if (nombre === selected) {
          opt.selected = true;
        }
        comunaSelect.appendChild(opt);
      });
      comunaSelect.disabled = comunas.length === 0;
    }

    renderComunas(comunaSelect.getAttribute("data-initial") || "");
    regionSelect.addEventListener("change", function () {
      renderComunas("");
    });
  })();
  (function(){
    const pills = Array.from(document.querySelectorAll("#agendaFilterPills button"));
    const cards = Array.from(document.querySelectorAll(".visit-card[data-state]"));
    const search = document.getElementById("agendaEmailSearch");
    const counter = document.getElementById("agendaCounter");
    let activeState = "all";

    function applyFilters() {
      const term = ((search && search.value) || "").trim().toLowerCase();
      let visible = 0;
      cards.forEach(function(card){
        const cardState = (card.dataset.state || "").toUpperCase();
        const cardEmail = (card.dataset.email || "").toLowerCase();
        const matchesState = activeState === "all" || cardState === activeState;
        const matchesEmail = !term || cardEmail.includes(term);
        const show = matchesState && matchesEmail;
        card.style.display = show ? "" : "none";
        if (show) visible += 1;
      });
      if (counter) {
        counter.textContent = visible;
      }
    }

    pills.forEach(function(btn){
      btn.addEventListener("click", function(){
        pills.forEach(function(b){ b.classList.remove("active"); });
        btn.classList.add("active");
        activeState = (btn.dataset.state || "all").toUpperCase();
        applyFilters();
      });
    });
    if (search) {
      search.addEventListener("input", applyFilters);
    }
    applyFilters();
  })();
</script>
</body>
</html>

{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Registro de Cotizaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'menu/css/style.css' %}?v=20241205">
  <style>
    :root {
      --admin-blue: rgb(0, 19, 93);
      --card-border: #e6e9f2;
      --soft: #f6f8ff;
      --muted: #6b7280;
    }
    body { background: #f5f7fb; }
    .page-shell { max-width: 1200px; }
    .hero {
      background: #fff;
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 14px 32px rgba(0,0,0,0.06);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .hero h1 { color: var(--admin-blue); font-weight: 800; }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 999px;
      background: rgba(0,19,93,0.08); color: var(--admin-blue);
      border: 1px solid rgba(0,19,93,0.14); font-weight: 700;
    }
    .filter-pills { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-pills button {
      border: 1px solid var(--card-border);
      background: #fff;
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 700;
      color: var(--muted);
      transition: all 0.2s ease;
    }
    .filter-pills button.active {
      background: var(--admin-blue);
      color: #fff;
      border-color: var(--admin-blue);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
    }
    .quote-card {
      background: #fff;
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.05);
    }
    .quote-head {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
      border-bottom: 1px dashed #dfe3ef;
      padding-bottom: 12px;
    }
    .quote-title { font-weight: 800; color: #111827; margin: 0; }
    .quote-meta { margin: 0; color: var(--muted); font-size: 0.94rem; }
    .status-pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 10px; font-weight: 700; font-size: 0.9rem;
    }
    .status-ACEPTADA { background: #e6f6ed; color: #166534; }
    .status-PROCESO_PAGO { background: #fff4d6; color: #8a6a00; }
    .status-RECHAZADA { background: #fde2e1; color: #b42318; }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px; }
    .info-box {
      background: var(--soft);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 12px;
      height: 100%;
    }
    .info-box h6 { margin: 0 0 4px; font-weight: 800; color: #111827; font-size: 0.95rem; }
    .info-box p { margin: 0; color: var(--muted); white-space: pre-line; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

{% include 'menu/partials/navbar.html' %}

<main class="container my-5 flex-grow-1 page-shell">
  <div class="mb-3">
    <a href="{% url 'admin_dashboard' %}" class="btn btn-link p-0 text-decoration-none">&larr; Volver a administrar</a>
  </div>

  <section class="hero mb-3">
    <div>
      <div class="d-flex align-items-center gap-2 mb-1">
        <span class="pill">Registro de cotizaciones</span>
        <span class="text-muted small">Total: {{ cotizaciones|length }}</span>
      </div>
      <h1 class="h4 mb-1">Solicitudes aceptadas o rechazadas</h1>
      <p class="hero-subtitle mb-0 text-muted">Filtra por estado y revisa cada detalle antes de autorizar o archivar.</p>
    </div>
    <div class="filter-pills" id="filterPills">
      <button type="button" class="active" data-state="all">Todas</button>
      <button type="button" data-state="ACEPTADA">Aceptadas</button>
      <button type="button" data-state="PROCESO_PAGO">Proceso de pago</button>
      <button type="button" data-state="RECHAZADA">Rechazadas</button>
    </div>
  </section>

  {% if cotizaciones %}
    <div class="d-flex flex-column gap-3" id="quotesWrapper">
      {% for c in cotizaciones %}
      <article class="quote-card" data-state="{{ c.estado }}">
        <div class="quote-head">
          <div>
            <h3 class="quote-title mb-1">{{ c.servicio.titulo|default:"Servicio sin título" }}</h3>
            <p class="quote-meta mb-0">{{ c.asunto|default:"Sin asunto" }}</p>
          </div>
          <div>
            <p class="quote-meta mb-1">Cliente: <strong>{{ c.usuario.get_full_name|default:c.usuario.username }}</strong></p>
            <p class="quote-meta mb-0 text-muted">{{ c.usuario.email }}</p>
          </div>
          <div class="text-end">
            <span class="status-pill status-{{ c.estado|default:'RECHAZADA' }}">{{ c.get_estado_display }}</span><br>
            <small class="text-muted">Resuelta: {{ c.resuelto_en|default:c.creado_en|date:"d/m/Y H:i" }}</small>
          </div>
        </div>

        <div class="info-grid mb-2">
          <div class="info-box">
            <h6>Ubicación</h6>
            <ul class="mb-0 text-muted small ps-3">
              <li><strong>Lugar:</strong> {{ c.lugar_servicio|default:"-" }}</li>
              <li><strong>Región/Comuna:</strong> {{ c.region|default:"-" }}/{{ c.comuna|default:"-" }}</li>
            </ul>
          </div>
          <div class="info-box">
            <h6>Mensaje</h6>
            <ul class="mb-0 text-muted small ps-3">
              <li><strong>Teléfono:</strong> {% firstof c.usuario.telefono "-" %}</li>
              <li><strong>Lugar:</strong> {{ c.lugar_servicio|default:"-" }}</li>
              <li><strong>Región/Comuna:</strong> {{ c.region|default:"-" }}/{{ c.comuna|default:"-" }}</li>
              <li><strong>Mensaje:</strong> {{ c.mensaje|default:"[Sin mensaje]" }}</li>
            </ul>
          </div>
          <div class="info-box">
            <h6>Estado y acciones</h6>
            <div class="actions">
              {% if c.estado == "ACEPTADA" %}
                <a href="{% url 'cotizacion_informe' c.pk %}" class="btn btn-sm btn-primary">Autorizar pago</a>
              {% elif c.estado == "PROCESO_PAGO" %}
                <a href="{% url 'cotizacion_informe' c.pk %}" class="btn btn-sm btn-outline-primary">Ver informe</a>
              {% else %}
                <span class="text-muted small">Sin acciones</span>
              {% endif %}
            </div>
            {% if c.motivo_rechazo %}
              <p class="mt-2 mb-0 text-muted small">Motivo: {{ c.motivo_rechazo }}</p>
            {% endif %}
          </div>
        </div>
      </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="bg-white p-5 text-center rounded shadow-sm border" style="border-color: var(--card-border);">
      <p class="mb-0 text-muted">Aún no hay cotizaciones resueltas.</p>
    </div>
  {% endif %}
</main>

{% include 'menu/partials/footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function(){
    var pills = document.querySelectorAll("#filterPills button");
    var cards = document.querySelectorAll("#quotesWrapper [data-state]");
    pills.forEach(function(btn){
      btn.addEventListener("click", function(){
        pills.forEach(function(b){ b.classList.remove("active"); });
        btn.classList.add("active");
        var state = btn.dataset.state;
        cards.forEach(function(card){
          var cState = card.dataset.state || "";
          card.style.display = (state === "all" || state === cState) ? "" : "none";
        });
      });
    });
  })();
</script>
</body>
</html>

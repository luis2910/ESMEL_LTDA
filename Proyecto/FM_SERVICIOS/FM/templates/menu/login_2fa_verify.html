{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Verificaci&oacute;n en dos pasos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'menu/css/style.css' %}?v=20241205">
</head>

<body class="d-flex flex-column min-vh-100">

{% include 'menu/partials/navbar.html' %}

<section class="container my-5 form-card p-4 rounded shadow-sm" style="max-width: 400px;">
  <h2 class="text-center mb-4">Verificaci&oacute;n en dos pasos</h2>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2 mb-3" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if debug_code %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
      Modo desarrollo: tu c&oacute;digo es <strong>{{ debug_code }}</strong>.
      {% if resend_remaining > 0 %}
        <br>Si no ves el correo, tambi&eacute;n puedes revisar la carpeta <code>sent_emails</code>.
      {% endif %}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
  {% endif %}

  {% if admin_mode %}
    <p class="text-muted">Ingresa el c&oacute;digo especial de administrador para completar el acceso.</p>
  {% elif tech_mode %}
    <p class="text-muted">Ingresa tu c&oacute;digo de t&eacute;cnico para confirmar que eres t&uacute;.</p>
  {% else %}
    <p class="text-muted">Hemos enviado un c&oacute;digo a tu correo. Expira en {{ minutes }} minutos.</p>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}
    <div class="mb-3">
      <label for="id_code" class="form-label">C&oacute;digo</label>
      {{ form.code }}
      {% if form.code.errors %}
        <div class="text-danger small">{{ form.code.errors|striptags }}</div>
      {% endif %}
    </div>
    <button type="submit" class="btn btn-primary w-100 mb-2">Verificar</button>
    {% if not admin_mode and not tech_mode %}
      <div class="text-center">
        <button id="resendBtn" name="action" value="resend" type="submit" class="btn btn-link" disabled>Reenviar c&oacute;digo (10s)</button>
      </div>
    {% endif %}
  </form>
</section>

{% include 'menu/partials/footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% if not admin_mode and not tech_mode %}
<script>
  (function(){
    var remaining = {{ resend_remaining|default:0 }};
    var btn = document.getElementById('resendBtn');
    var input = document.getElementById('id_code');

    function sanitizeValue(v){
      v = (v || '').replace(/\D+/g, '');
      if (v.length > 6) v = v.slice(0,6);
      return v;
    }
    if (input) {
      input.addEventListener('input', function(){
        var sanitized = sanitizeValue(input.value);
        if (sanitized !== input.value) input.value = sanitized;
      });
      input.addEventListener('paste', function(e){
        e.preventDefault();
        var text = (e.clipboardData || window.clipboardData).getData('text');
        input.value = sanitizeValue(text);
      });
      input.addEventListener('drop', function(e){
        e.preventDefault();
      });
      input.addEventListener('keypress', function(e){
        var c = e.which || e.keyCode;
        var ch = String.fromCharCode(c);
        if (!/[0-9]/.test(ch)) {
          e.preventDefault();
        }
      });
    }
    function update() {
      if (!btn) return;
      if (remaining <= 0) {
        btn.disabled = false;
        btn.textContent = 'Reenviar c\u00f3digo';
        return;
      }
      btn.disabled = true;
      btn.textContent = 'Reenviar c\u00f3digo (' + remaining + 's)';
      remaining -= 1;
      setTimeout(update, 1000);
    }
    if (!remaining || remaining < 0) remaining = 10;
    update();
  })();
</script>
{% endif %}
</body>
</html>

{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Técnicos y agenda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'menu/css/style.css' %}?v=20241205">
  <style>
    :root {
      --panel-blue: rgb(0, 19, 93);
      --panel-gradient: linear-gradient(120deg, #00338d, #0077ff);
      --panel-border: rgba(0,0,0,0.06);
      --muted: #6b7280;
    }
    .btn-circle-select {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid #0d6efd;
      background: transparent;
      color: #0d6efd;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .btn-circle-select.is-selected {
      background: #0d6efd;
      color: #fff;
    }
    .hero-panel {
      background: var(--panel-blue);
      color: #fff;
      border: 1px solid var(--panel-border);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    }
    .hero-panel h1 { font-weight: 800; margin-bottom: 6px; }
    .hero-panel p { margin: 0; color: rgba(255,255,255,0.85); }
    .hero-panel .btn-light { font-weight: 700; }
    .table-modern thead { background: #f3f6ff; }
    .table-modern tbody tr + tr { border-top: 1px solid #e5e9f2; }
    .table-modern tbody tr:hover { background: #f1f5ff; }
    .table-modern tbody tr:nth-child(odd) { background: #f9fbff; }
    .table-modern td, .table-modern th { padding: 12px; vertical-align: middle; }
    .table-modern tbody tr[data-estado="PENDIENTE"] { border-left: 4px solid #f59e0b; }
    .table-modern tbody tr[data-estado="ACEPTADA"] { border-left: 4px solid #16a34a; }
    .table-modern tbody tr[data-estado="PROCESO_PAGO"] { border-left: 4px solid #0ea5e9; }
    .table-modern tbody tr[data-estado="COMPLETADA"] { border-left: 4px solid #1d4ed8; }
    .table-modern tbody tr[data-estado="RECHAZADA"] { border-left: 4px solid #ef4444; }
    .table-modern tbody tr[data-estado="SIN"] { border-left: 4px solid #9ca3af; }
    .status-badge { font-weight: 700; }
    .filter-chip {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #e5e9f2;
      background: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .filter-chip select { border: none; outline: none; background: transparent; }
  </style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">

{% include 'menu/partials/navbar.html' %}

<main class="container my-5 flex-grow-1">
  {% if tech_messages %}
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000;">
      {% for message in tech_messages %}
        {% with level=message.level_tag %}
        <div class="toast align-items-center text-bg-{{ level|default:'primary' }} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4500" data-bs-autohide="true">
          <div class="d-flex">
            <div class="toast-body">
              {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('.toast').forEach(function(toastEl){
          var t = new bootstrap.Toast(toastEl);
          t.show();
        });
      });
    </script>
  {% endif %}

  <div class="hero-panel mb-4">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
      <div>
        <p class="text-uppercase small mb-1 opacity-75">Panel operativo</p>
        <h1 class="h3 mb-2 fw-semibold">{% if is_admin %}Administrar técnicos{% else %}Mi agenda{% endif %}</h1>
        <p class="mb-3 opacity-75">
          {% if is_admin %}
            Añade técnicos, filtra por servicio y revisa sus visitas.
          {% else %}
            Revisa tu agenda y visitas programadas.
          {% endif %}
        </p>
        {% if is_admin %}
        <a href="{% url 'admin_dashboard' %}" class="btn btn-light btn-sm text-primary fw-semibold">&larr; Volver al panel</a>
        {% endif %}
      </div>
    </div>
  </div>

  <section class="row g-3 mb-3">
    <div class="col-12 mb-2">
      <form method="get" class="d-flex flex-wrap gap-2 align-items-center">
        <label class="form-label me-2 mb-0">Servicios:</label>
        <select name="servicio" class="form-select form-select-sm" style="max-width: 260px;" onchange="this.form.submit()">
          <option value="">Todos los servicios</option>
          {% for s in servicios %}
            <option value="{{ s.slug }}" {% if servicio_filter == s.slug %}selected{% endif %}>{{ s.titulo }}</option>
          {% endfor %}
        </select>
        {% if servicio_filter %}
          <a href="{% url 'tecnicos_panel' %}" class="btn btn-link btn-sm text-decoration-none">Limpiar filtro</a>
        {% endif %}
      </form>
    </div>

    {% for tec in tecnicos %}
      <div class="col-md-4">
        <div class="h-100 p-3 border rounded-4 shadow-sm {% if tec.slug == selected.slug %}border-primary bg-white{% else %}bg-light{% endif %}">
          <div class="d-flex justify-content-between align-items-start mb-1">
            <div>
              <p class="text-uppercase text-muted small mb-1">Técnico</p>
              <h3 class="h5 mb-0">{{ tec.nombre }}</h3>
            </div>
            {% if is_admin %}
            <button
              class="btn-circle-select {% if tec.slug == selected.slug %}is-selected{% endif %}"
              type="button"
              onclick="window.location.href='{% url 'tecnicos_panel' %}?tecnico={{ tec.slug }}#tecnicoEdit'"
              title="Seleccionar para editar/eliminar"
            >
              {% if tec.slug == selected.slug %}✓{% else %}&bull;{% endif %}
            </button>
            {% endif %}
          </div>
          <p class="text-muted small mb-1">{{ tec.especialidad }}</p>
          <p class="text-muted small mb-2">Servicio: {{ tec.servicio|default:tec.servicio_slug|default:"Sin servicio" }}</p>
          <span class="badge bg-secondary">{{ tec.slug }}</span>
          <div class="mt-3">
            <a href="{% url 'tecnicos_panel' %}?tecnico={{ tec.slug }}" class="btn btn-sm btn-primary w-100">Ver agenda</a>
          </div>
        </div>
      </div>
    {% endfor %}
  </section>

  {% if is_admin %}
  <div class="d-flex flex-wrap gap-2 mb-4">
    <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#tecnicoForm" aria-expanded="false" aria-controls="tecnicoForm">Añadir técnico</button>
    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#tecnicoEdit" aria-expanded="false" aria-controls="tecnicoEdit">Editar</button>
    <form method="post" action="{% url 'tecnicos_panel' %}" class="d-inline">
      {% csrf_token %}
      <input type="hidden" name="action" value="eliminar_tecnico">
      <input type="hidden" name="tecnico_slug" value="{{ selected.slug }}">
      <button type="submit" class="btn btn-outline-danger btn-sm" {% if not selected.slug %}disabled{% endif %}>Eliminar</button>
    </form>
  </div>

  <div class="collapse mb-4" id="tecnicoForm">
    <div class="bg-white rounded-4 shadow-sm p-4">
      <h2 class="h5 mb-3">Añadir técnico</h2>
      <form method="post" action="{% url 'tecnicos_panel' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="crear_tecnico">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label small text-muted">Nombre</label>
            <input type="text" name="nombre" class="form-control" placeholder="Nombre" required>
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">Apellido</label>
            <input type="text" name="apellido" class="form-control" placeholder="Apellido">
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">RUT</label>
            <input type="text" name="rut" class="form-control" placeholder="12.345.678-9" required>
            <div class="invalid-feedback d-block small text-danger rut-error d-none">Ingresa un RUT válido (ej: 12.345.678-9).</div>
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">Teléfono</label>
            <input type="tel" name="telefono" class="form-control" placeholder="+56 9 1234 5678">
            <div class="invalid-feedback d-block small text-danger tel-error d-none">Ingresa un teléfono válido (ej: +56 9 1234 5678).</div>
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">Correo</label>
            <input type="email" name="correo" class="form-control" placeholder="correo@ejemplo.cl" required>
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">Servicio asignado</label>
            <select name="servicio" class="form-select">
              <option value="">Selecciona servicio</option>
              {% for s in servicios %}
                <option value="{{ s.slug }}">{{ s.titulo }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-3">
          <button type="submit" class="btn btn-primary btn-sm">Guardar técnico</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#tecnicoForm">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="collapse mb-4" id="tecnicoEdit">
    <div class="bg-white rounded-4 shadow-sm p-4">
      <h2 class="h5 mb-3">Editar técnico</h2>
      <form method="post" action="{% url 'tecnicos_panel' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="editar_tecnico">
        <input type="hidden" name="tecnico_slug" value="{{ selected.slug }}">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label small text-muted">Nombre</label>
            <input type="text" name="nombre" class="form-control" value="{{ selected.nombre_raw|default:selected.nombre }}" required>
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">Apellido</label>
            <input type="text" name="apellido" class="form-control" value="{{ selected.apellido_raw|default:selected.apellido|default:'' }}">
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">RUT</label>
            <input type="text" name="rut" class="form-control" value="{{ selected.rut|default:'' }}">
            <div class="invalid-feedback d-block small text-danger rut-error d-none">Ingresa un RUT válido (ej: 12.345.678-9).</div>
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">Teléfono</label>
            <input type="tel" name="telefono" class="form-control" value="{{ selected.telefono|default:'' }}">
            <div class="invalid-feedback d-block small text-danger tel-error d-none">Ingresa un teléfono válido (ej: +56 9 1234 5678).</div>
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">Correo</label>
            <input type="email" name="correo" class="form-control" value="{{ selected.correo|default:'' }}">
          </div>
          <div class="col-md-6">
            <label class="form-label small text-muted">Servicio asignado</label>
            <select name="servicio" class="form-select">
              <option value="">Selecciona servicio</option>
              {% for s in servicios %}
                <option value="{{ s.slug }}" {% if selected.servicio_slug == s.slug %}selected{% endif %}>{{ s.titulo }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-3">
          <button type="submit" class="btn btn-primary btn-sm" {% if not selected.slug %}disabled{% endif %}>Guardar cambios</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#tecnicoEdit">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <section class="bg-white rounded-4 shadow-sm p-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
        <div>
          <h2 class="h5 mb-0">Visitas programadas</h2>
          <p class="text-muted mb-0">Estados y contactos</p>
        </div>
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button type="button" class="badge bg-warning text-dark px-3 py-2 shadow-sm border-0 filtro-badge" data-filter="PENDIENTE">Pendientes: {{ stats.pendientes }}</button>
        <button type="button" class="badge bg-success px-3 py-2 shadow-sm border-0 filtro-badge" data-filter="ACEPTADA">Aceptadas: {{ stats.aceptadas }}</button>
        <button type="button" class="badge bg-primary px-3 py-2 shadow-sm border-0 filtro-badge" data-filter="COMPLETADA">Completadas: {{ stats.completadas }}</button>
        <button type="button" class="badge bg-warning text-dark px-3 py-2 shadow-sm border-0 filtro-badge" data-filter="PROCESO_PAGO">Proceso de pago: {{ stats.proceso_pago }}</button>
        <button type="button" class="badge bg-secondary px-3 py-2 shadow-sm border-0 filtro-badge" data-filter="SIN">Finalizadas: {{ stats.finalizadas }}</button>
      </div>
    </div>

    {% if visitas %}
      <div class="table-responsive table-modern">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Dirección</th>
              <th>Notas</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="visitasTable">
        {% for visita in visitas|dictsortreversed:"fecha" %}
          {% with estado=visita.cotizacion.estado|default_if_none:"SIN" %}
          <tr class="rounded-3" data-estado="{{ estado|default:'SIN' }}">
            <td>
              <strong>{{ visita.cliente }}</strong><br>
              <span class="text-muted small">{{ visita.correo|default:"-" }}</span>
            </td>
                <td class="text-nowrap">{{ visita.fecha|date:"d/m/Y" }}</td>
                <td>{{ visita.hora|default:"-" }}</td>
                <td class="small">{{ visita.direccion|default:"-" }}<br><span class="text-muted">{{ visita.region|default:"-" }}/{{ visita.comuna|default:"-" }}</span></td>
                <td style="white-space: pre-line;" class="small">{{ visita.notas }}</td>
                <td>
                {% if visita.cotizacion %}
                  {% if visita.cotizacion.estado == 'PENDIENTE' %}
                    <span class="badge text-bg-warning text-dark status-badge">Pendiente</span>
                  {% elif visita.cotizacion.estado == 'ACEPTADA' %}
                    <span class="badge text-bg-success status-badge">Aceptada</span>
                  {% elif visita.cotizacion.estado == 'PROCESO_PAGO' %}
                    <span class="badge text-bg-info text-dark status-badge">Proceso de pago</span>
                  {% elif visita.cotizacion.estado == 'COMPLETADA' %}
                    <span class="badge text-bg-primary status-badge">Completada</span>
                  {% elif visita.cotizacion.estado == 'RECHAZADA' %}
                    <span class="badge text-bg-danger status-badge">Rechazada</span>
                  {% else %}
                    <span class="badge text-bg-secondary status-badge">{{ visita.cotizacion.estado }}</span>
                  {% endif %}
                {% else %}
                  <span class="badge text-bg-secondary status-badge">Sin cotización</span>
                {% endif %}
              </td>
              <td class="text-nowrap">
                {% if not visita.cotizacion or visita.cotizacion.estado == 'PENDIENTE' %}
                  <a href="{% url 'agenda_visita_editar' visita.pk %}" class="btn btn-sm btn-outline-primary mb-1">Editar</a>
                  <form method="post" action="{% url 'agenda_visita_eliminar' visita.pk %}" class="d-inline">
                    {% csrf_token %}
                      <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar esta visita?')">Eliminar</button>
                    </form>
                {% endif %}
                {% if visita.cotizacion and visita.cotizacion.estado == 'ACEPTADA' %}
                  <div class="mt-2">
                    <a href="{% url 'cotizacion_informe' visita.cotizacion.pk %}" class="btn btn-sm btn-primary w-100">Generar informe</a>
                  </div>
                {% endif %}
              </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center text-muted py-4">
        Este técnico aún no tiene visitas agendadas.
      </div>
    {% endif %}
  </section>
</main>

{% include 'menu/partials/footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function() {
    // Validaciones lado cliente (formato clásico, mismo que backend relajado)
    const rutRegex = /^\d{1,2}\.?\d{3}\.?\d{3}-?[0-9kK]$/;
    const telRegex = /^\+?\d[\d\s-]{7,}$/;
    function wire(formId) {
      const form = document.querySelector(formId);
      if (!form) return;
      const btn = form.querySelector('button[type=\"submit\"]');
      const rutField = form.querySelector('input[name=\"rut\"]');
      const telField = form.querySelector('input[name=\"telefono\"]');
      const nameField = form.querySelector('input[name=\"nombre\"]');
      const emailField = form.querySelector('input[name=\"correo\"]');
      const rutErr = form.querySelector('.rut-error');
      const telErr = form.querySelector('.tel-error');
      function validate() {
        let ok = true;
        const rutVal = (rutField?.value || '').trim();
        if (rutField) {
          const rv = rutRegex.test(rutVal);
          rutErr?.classList.toggle('d-none', rv || !rutVal);
          ok = ok && rv;
        }
        const telVal = (telField?.value || '').trim();
        if (telField && telVal) {
          const tv = telRegex.test(telVal);
          telErr?.classList.toggle('d-none', tv);
          ok = ok && tv;
        } else {
          telErr?.classList.add('d-none');
        }
        if (nameField) ok = ok && !!nameField.value.trim();
        if (emailField) ok = ok && !!emailField.value.trim();
        if (btn) btn.disabled = !ok;
      }
      [rutField, telField, nameField, emailField].forEach(el => el && el.addEventListener('input', validate));
      validate();
    }
    document.addEventListener('DOMContentLoaded', function() {
      wire('#tecnicoForm form');
      wire('#tecnicoEdit form');
    });

    // Filtro por estado
    const rows = document.querySelectorAll("#visitasTable tr[data-estado]");
    function applyFilter(val) {
      const filterVal = val || "all";
      rows.forEach(tr => {
        const st = tr.getAttribute("data-estado") || "";
        tr.style.display = (filterVal === "all" || st === filterVal) ? "" : "none";
      });
    }

    document.querySelectorAll(".filtro-badge").forEach(btn => {
      btn.addEventListener("click", function(){
        const val = this.dataset.filter || "all";
        applyFilter(val);
      });
    });
  })();
</script>
</body>
</html>
